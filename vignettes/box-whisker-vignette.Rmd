---
title: "Box-Whisker Plots"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Box-Whisker Plots}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  fig.show = "hold",
  comment = "#>"
)
```

```{r setup}
library(ospsuite.plots)
library(tidyr)

# setDefaults
ospsuite.plots::setDefaults()


# Adjust default theme plot for prettier  plots
theme_update(legend.position = "top")
theme_update(legend.direction = "horizontal")
theme_update(plot.caption = element_text(hjust = 1))
```

# 1. Introduction

The following vignette aims at documenting and illustrating workflows for producing box-and-whisker plots using the `ospsuite.plots`-Library.



The function for plotting box-whiskers is: `plotBoxWhisker`. 
Basic documentation of the function can be found using: `?plotBoxWhisker`.
The output of the function is a `ggplot` object.


# 2. Examples

## 2.1. Data

To illustrate the workflow to produce boxplots, let's use the `pkRatioDataExample.RData` example data from the `extdata` folder.

It includes the dataset `pkRatioData`:

```{r load-data, results='asis'}
pkRatioData <- exampleDataCovariates %>%
  dplyr::filter(SetID == "DataSet1") %>%
  dplyr::mutate(SetID = NULL) %>%
  dplyr::group_by(Country) %>%
  dplyr::mutate(meanAge = round(mean(Age), 2))

pkRatioMetaData <- attr(exampleDataCovariates, "metaData")
pkRatioMetaData[["meanAge"]] <- pkRatioMetaData[["Age"]]
pkRatioMetaData <- pkRatioMetaData[intersect(names(pkRatioData), names(pkRatioMetaData))]


# show data
knitr::kable(utils::head(pkRatioData), digits = 2, caption = "first rows of data")

knitr::kable(metaData2DataFrame(pkRatioMetaData), caption = "list of meta data")
```


## 2.2. Basic examples

- A) In the minimal example, only the basic `y` variable name is indicated. Here, `"Age"` was chosen for the boxplot.  
- B) Age (mapped to y) is aggregated for different countries (mapped to x)
- C) Age (mapped to y) is aggregated for different countries (mapped to fill)
- C) Age (mapped to y) is aggregated for different countries  (mapped to x) and Sex (mapped to fill)


```{r minimal example}
# A minimal example
plotBoxWhisker(
  data = pkRatioData,
  mapping = aes(y = Age),
  metaData = pkRatioMetaData
) +
  labs(tag = "A")


# B Boxplot mapping Country as x"
plotBoxWhisker(
  mapping = aes(
    x = Country,
    y = Age
  ),
  data = pkRatioData,
  metaData = pkRatioMetaData
) +
  labs(tag = "B")


# C Boxplot mapping Country as fill"
plotBoxWhisker(
  mapping = aes(
    fill = Country,
    y = Age
  ),
  data = pkRatioData,
  metaData = pkRatioMetaData
) +
  labs(tag = "C")


# D Boxplot mapping Country as x Sex as fill"
plotBoxWhisker(
  mapping = aes(
    x = Country,
    y = Age,
    fill = Sex
  ),
  data = pkRatioData,
  metaData = pkRatioMetaData
) +
  labs(tag = "D")
```

## 2.3 Examples with numeric - x axis

It is also possible to create boxplots for distinct numeric values:

* A) The numeric x -column was converted to a factor. It is displayed like categorical values 
* B) Here the x- Axis is numeric, but it is necessary to add an additionally mapping group = x Mapping


```{r numeric-example}
# A Boxplot with numeric x Axis as factor
plotBoxWhisker(
  mapping = aes(
    x = as.factor(meanAge),
    y = Ratio,
    fill = Country
  ),
  data = pkRatioData,
  metaData = pkRatioMetaData
) +
  labs(tag = "A")

# B Boxplot with numeric x Axis and continuous axis
plotBoxWhisker(
  mapping = aes(
    x = meanAge,
    group = meanAge,
    y = Ratio,
    fill = Country
  ),
  data = pkRatioData,
  metaData = pkRatioMetaData,
  xscale.args = list(limits = c(29, 31))
) +
  labs(tag = "B")
```



## 2.3. Aggregation function

By default the data is aggregated by percentiles defined by the default option `ospsuite.plots.Percentiles`.
The percentiles can be customized for a specific plot by the input variable `percentiles` or for all plots generated by `plotBoxwhisker()` by changing the default options (`options(ospsuite.plots.Percentiles = c(0.05, 0.25, 0.5, 0.75, 0.95))`).

It is also possible to use a customized function via the input variable `statFun`. If `statFun`is not `NULL` it will overwrite the percentiles.


**Important**: If you override the defaults this way, please make sure to specify this in the plot annotations as you are basically redefining a boxplot and the reader might not be aware of this and will misinterpret the plot.

## 2.3.1 Example for customized percentiles

- A) Use "2.5th" and "97.5th" percentile for whiskers
- B) Do not show whiskers, by setting whisker percentiles to box percentiles

```{r}
# A  Use 0.025 and 0975 for whiskers
plotBoxWhisker(
  mapping = aes(
    x = Country,
    y = Age
  ),
  data = pkRatioData,
  metaData = pkRatioMetaData,
  percentiles = c(0.025, 0.25, 0.5, 0.75, 0.975)
) +
  labs(
    tag = "A",
    caption = "whisker indicate 95% range"
  )


# B  No whiskers
plotBoxWhisker(
  mapping = aes(
    x = Country,
    y = Age
  ),
  data = pkRatioData,
  metaData = pkRatioMetaData,
  percentiles = c(0.25, 0.25, 0.5, 0.75, 0.75)
) +
  labs(tag = "B")
```

## 2.3.1 Example for customized aggregation function

For instance, when a normal distribution is assumed, mean and standard deviation would be preferred:

```{r aggregation-functions-1, fig.cap="Boxplot mapping Country as x, Sex as fill and assuming normal distribution"}
myStatFun <- function(y) {
  r <- list(
    ymin = mean(y) - 1.96 * stats::sd(y),
    lower = quantile(y, probs = 0.25, names = FALSE),
    middle = mean(y),
    upper = quantile(y, probs = 0.75, names = FALSE),
    ymax = mean(y) + 1.96 * stats::sd(y)
  )
  return(r)
}


plotBoxWhisker(
  mapping = aes(
    x = Country,
    y = Age
  ),
  data = pkRatioData,
  metaData = pkRatioMetaData,
  statFun = myStatFun
) +
  labs(
    tag = "A",
    caption = "mean for the middle line,
       25th and 75th percentile  for the box edges
       and mean +/- 1.96 standard deviation for the whiskers"
  )

myStatFun2 <- function(y) {
  r <- list(
    ymin = mean(y) - 1.96 * stats::sd(y),
    lower = mean(y) - stats::sd(y),
    middle = mean(y),
    upper = mean(y) + stats::sd(y),
    ymax = mean(y) + 1.96 * stats::sd(y)
  )
  return(r)
}

plotBoxWhisker(
  mapping = aes(
    x = Country,
    y = Age
  ),
  data = pkRatioData,
  metaData = pkRatioMetaData,
  statFun = myStatFun2
) +
  labs(
    tag = "B",
    caption = "mean for the middle line,
       mean +/- standard deviation for the box edges
       and mean +/- 1.96 standard deviation for the whiskers"
  )
```

## 2.3.2 Tables corresponding to plot

As there already exist a lot off possibilities to aggregate data in R, this package does not provide an extra function.
But the `plotBoxWhisker()` adds the aggregation function to the plot object. So the aggregation can be done easily e.g. with package {data.table}

```{r aggregationTable}
# generate plot object
plotObject <- plotBoxWhisker(
  mapping = aes(
    x = Country,
    y = Age,
    fill = Sex
  ),
  data = pkRatioData,
  metaData = pkRatioMetaData
)

plot(plotObject)

# convert data to data.table and use  statFun saved in plotObject for aggregation
# make sure to add all relevant aesthetics to "by" columns
dt <- pkRatioData %>%
  setDT() %>%
  .[, as.list(plotObject$statFun(Age)),
    by = c("Country", "Sex")
  ]

knitr::kable(dt)
```




## 2.4. Outlier functions

Outliers are displayed if variable `outliers` is TRUE. 
Default outliers are flagged when outside the range from "25th" percentile - 1.5 x IQR to "75th" percentiles + 1.5 x IQR, as suggested by McGill and
implemented by the current boxplot functions from ggplot (`geom_boxplot`).
However, these default can also be overridden. 

### 2.4.1 Examples

In the following example, outliers will be flagged when   

- A) outside the default range 
- B) values are out of the "10th-90th" percentiles, while whiskers will go until these same percentiles:


```{r example-outliers}
plotBoxWhisker(
  mapping = aes(
    x = Sex,
    y = Ratio,
    fill = Country
  ),
  data = pkRatioData,
  metaData = pkRatioMetaData,
  outliers = TRUE
) +
  labs(
    tag = "A",
    caption = "Default settings: Whisker indicate 90% range (5th - 95th percentile)
       and outlier indicate all measurements outside
       25th percentiles - 1.5 x IQR to 75th percentiles + 1.5 x IQR"
  )




myStatFun <- function(y) {
  r <- stats::quantile(y, probs = c(0.1, 0.25, 0.5, 0.75, 0.9), names = FALSE, na.rm = TRUE)
  names(r) <- c("ymin", "lower", "middle", "upper", "ymax")
  return(r)
}


myStatFunOutlier <-
  function(x) {
    q <- stats::quantile(x, probs = c(0.1, 0.9), names = FALSE, na.rm = TRUE)
    pp <- subset(x, x < q[1] |
      x > q[2])
    if (length(pp) < 1) {
      return(as.double(NA))
    } else {
      return(pp)
    }
  }



plotBoxWhisker(
  data = pkRatioData,
  metaData = pkRatioMetaData,
  mapping = aes(
    x = Sex,
    y = Ratio,
    fill = Country
  ),
  outliers = TRUE,
  statFun = myStatFun,
  statFunOutlier = myStatFunOutlier
) +
  labs(
    tag = "B",
    caption = "Whisker indicate 80% range (10th - 90th percentile)
       and outlier indicate all measurements outside whiskers"
  )
```

## 2.4.1 Retrieve outlier as Table

The `plotBoxWhisker()` adds the outlier function to the plot object. So outliers can be easily retrieved e.g. with package {data.table}


```{r outlierTable}
# generate plotObject
plotObject <- plotBoxWhisker(
  data = pkRatioData,
  metaData = pkRatioMetaData,
  mapping = aes(
    x = Sex,
    y = Ratio,
    fill = Country
  ),
  outliers = TRUE,
  statFun = myStatFun,
  statFunOutlier = myStatFunOutlier
)

# convert data to data.table and use  statFun saved in plotObject for aggregation
# make sure to add all relevant aesthetics to "by" columns
dt <- pkRatioData %>%
  setDT() %>%
  .[, .(outliers = plotObject$statFunOutlier(Ratio)),
    by = c("Country", "Sex")
  ]

knitr::kable(dt)
```




# 3. Plot configuration of boxplots

Below you see an example of the same plot  

* A) default layout
* B) customized layout

  *  the variable `geomBoxplotAttributes`  has now an entry for color 'orange', but it still keeps has the default value for position.
  *  the variable `geomPointAttributes`  has now an entry for size = 4, and shape = 'diamond', but it still keeps has the default value for position.
  * color was added to the mapping so the outliers points are also colored corresponding to 'Sex'
  * with `scale_fill_manual` and `scale_color_manual` the colors for the 'Sex' are defined
       



```{r boxplot-update-configuration, fig.cap="Boxplot with updated plot configuration"}
# A default layout
plotBoxWhisker(
  data = pkRatioData,
  metaData = pkRatioMetaData,
  mapping = aes(
    x = Country,
    y = Age,
    fill = Sex
  ),
  outliers = TRUE,
  statFun = myStatFun,
  statFunOutlier = myStatFunOutlier
) +
  labs(tag = "A")


# B customized layout
plotBoxWhisker(
  data = pkRatioData,
  metaData = pkRatioMetaData,
  mapping = aes(
    x = Country,
    y = Age,
    color = Sex,
    fill = Sex
  ),
  outliers = TRUE,
  statFun = myStatFun,
  statFunOutlier = myStatFunOutlier,
  geomBoxplotAttributes = list(
    color = "orange",
    position = position_dodge(width = 1)
  ),
  geomPointAttributes = list(
    position = position_dodge(width = 1),
    size = 4,
    shape = "diamond"
  )
) +
  scale_fill_manual(values = c(
    Female = "pink",
    Male = "dodgerblue"
  )) +
  scale_color_manual(values = c(
    Female = "pink",
    Male = "dodgerblue"
  )) +
  labs(tag = "B")
```


