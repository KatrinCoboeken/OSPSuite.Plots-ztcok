---
title: "PK-Ratio Plots"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{PK-Ratio Plots}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  fig.show = "hold",
  comment = "#>"
)
```

```{r setup}
library(ospsuite.plots)
library(tidyr)

# setDefaults
ospsuite.plots::setDefaults()


```

# 1. Introduction

The following vignette aims at documenting and illustrating workflows for producing PK ratio plots using the `ospsuite.plots`-Library.


# 2. Illustration of basic PK ratio plots

## 2.1. Data

The data showed in the sequel is available at the following path: `system.file("extdata", "test-data.csv", package = "tlf")`.
In the code below, the data is loaded and assigned to `pkRatioData`.

```{r load-data, results='asis'}
# Load example
pkRatioData <- exampleDataCovariates %>%
  dplyr::filter(SetID == "DataSet1") %>%
  dplyr::select(- c("SetID"))


metaData <- attr(exampleDataCovariates, "metaData")
metaData <- metaData[intersect(names(pkRatioData), names(metaData))]

knitr::kable(head(pkRatioData), digits = 3)

knitr::kable(metaData2DataFrame(metaData), digits = 3)

```


## 2.2. Examples for `plotPKRatio`

The function plotting PK ratios is: `plotPKRatio()`. 
Basic documentation of the function can be found using: `?plotPKRatio`.

Below are examples for  

* A basic example without grouping
* B basic example with error bars. aesthetics `error` and `error_relative` are also possible.
* C group by Sex using aesthetic `group`, aesthetics defined in variable  `groupAesthetics` are used to display group.
* D group by Sex and  Country and Age group combination using speicfied aesthetics.


```{r minimal-example}

# A
plotPKRatio(
  data = pkRatioData,
  mapping =  aes(x = Age,
                 y =  Ratio),
  metaData = metaData
) +
  labs(title = 'basic example',
       tag = 'A')

# B
plotPKRatio(
  data = pkRatioData,
  mapping =  aes(
    x = Age,
    y =  Ratio,
    ymin = Ratio * 1.05,
    ymax = Ratio / 1.05
  ),
  metaData = metaData
) +
  labs(title = 'basic example with errorbars',
       tag = 'B')

# C
plotPKRatio(
  data = pkRatioData,
  mapping =  aes(x = Age, y =  Ratio, group = Sex),
  metaData = metaData
) +
  labs(title = 'group by sex',
       tag = 'C')

# D
plotPKRatio(
  data = pkRatioData,
  mapping = aes(
    x = Age,
    y = Ratio,
    color = Sex,
    fill = Sex,
    shape = interaction(Country, AgeBin, sep = '-')
  )
) +
  labs(title = 'group by sex and  Country/Age combination',
       shape = 'Country/Age',
       tag = 'D')

```



## 2.3  PK values defined in `lines`

In PK ratio examples, usually horizontal lines are added allowing to flag values in and out of the [0.67-1.5] as well as [0.5-2.0] ranges.
The value mapping these horizontal lines was predefined as a named list: `foldDistance` with identity =1, '1.5 fold' = c(1.5, 1 / 1.5),
                          '2 fold' = c(2, 1 / 2).

Overwriting these value is possible by changing the variable `foldDistance.`
For instance:

```{r linesMapping-plot}
plotPKRatio(
  data = pkRatioData,
  mapping = aes(x = Age,
                    y = Ratio,
                    group = Sex),
  foldDistance = list(identity = 1,'5 fold' = c(0.2, 5))
)
```

# 3. Qualification of PK Ratios

If the package data.table is installed the {ggplot} object returned by `plotPKRatio` has an additional entry `PKRatioMeasure`,  which contains a `data.frame` with the PK ratios within the specific ranges given by variable `foldDistance`.

To calculate this the function `getPKRatioMeasure` is called internally with variable groups= NULL.
If you want to calculate the PK-Ratios  with stratification you can call `getPKRatioMeasure` and define the stratification with the variable `groups`


```{r, results='asis'}


plotObject = plotPKRatio(data = pkRatioData, 
                         mapping = aes(
                           x = Age,
                           y = Ratio,
                           group = Sex),
                         metaData = metaData) 


plot(plotObject)
knitr::kable(plotObject$PKRatioMeasure,caption = 'pK Ratios not stratified')


PKRatioMeasure_Sex = getPKRatioMeasure(data = pkRatioData,
                                   yColumn = 'Ratio',
                                   groups = c('Sex'))

knitr::kable(PKRatioMeasure_Sex,caption = 'pK Ratios stratified by Sex')

```


